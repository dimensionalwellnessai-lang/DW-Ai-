Perfect — with Vite + React + Wouter on the frontend and Express + sessions on the backend, you can do Option 1 (same app, hidden route) the right way:
	•	UI-level guard (so users don’t see it)
	•	Server/API-level guard (so users can’t hit it even if they guess the URL)

Below is the copy/paste spec for Replit AI to implement with your exact stack.

⸻

✅ GOAL

Create an Admin Analytics page at:
	•	Frontend route: /admin/analytics
	•	Backend endpoints: /api/admin/*

Only users with role = "admin" can access.

Users should get:
	•	Redirect or “Not authorized” UI on the frontend
	•	403 from the backend if they hit admin endpoints

⸻

1) DATABASE + USER MODEL UPDATE (Drizzle + Postgres)

1.1 Add role to users table

Add a column:
	•	role: 'user' | 'admin' default 'user'

Acceptance
	•	New users default to user
	•	You can manually set one account to admin in DB

⸻

2) BACKEND: ADMIN GUARD (Express Sessions)

2.1 Add these helpers in backend

requireAuth
	•	If no session user → 401

requireAdmin
	•	If no session user → 401
	•	If user.role !== 'admin' → 403

Important: This is the real protection.

⸻

3) BACKEND: ADMIN ANALYTICS ENDPOINTS

Create admin-only endpoints that return aggregated metrics.

3.1 Minimum endpoints (MVP)
	•	GET /api/admin/metrics/summary
returns: DAU, activation7d, d7MeaningfulRetention, helpedPositiveRate
	•	GET /api/admin/metrics/funnel?range=7d|30d
	•	GET /api/admin/metrics/switches?range=7d|30d
	•	GET /api/admin/metrics/recommendations?range=7d|30d
	•	GET /api/admin/metrics/flags?range=14d
	•	GET /api/admin/metrics/errors?range=7d|30d

All must use requireAdmin.

Acceptance
	•	Non-admin gets 403 for all /api/admin/*
	•	Admin gets JSON payloads
	•	No endpoint returns raw free-text

⸻

4) FRONTEND: ROLE FETCH + APP STATE (React Query)

4.1 Add “who am I” endpoint if not already present
	•	GET /api/me → returns { userId, email?, role }

Front-end uses React Query to cache it:
	•	query key: ["me"]

Acceptance
	•	App knows me.role
	•	If not logged in, me is null

⸻

5) FRONTEND: WOUTER ROUTE GUARD

5.1 Create <AdminRoute> wrapper

Behavior:
	•	While me is loading → show a loader
	•	If me null → redirect to /login
	•	If me.role !== 'admin' → show “Not authorized” screen
	•	Else render children

Acceptance
	•	/admin/analytics never loads for users
	•	Even if they type URL manually, they get blocked

⸻

6) FRONTEND: ADMIN ANALYTICS PAGE LAYOUT (Recharts + shadcn/ui)

Route: /admin/analytics

6.1 Page sections (exact)

Row 1 — KPI Tiles (4)
	•	DAU
	•	Activation Rate (7d)
	•	D7 Meaningful Retention
	•	Helped Positive Rate

Row 2 — Activation Funnel
	•	a vertical funnel list is fine for MVP:
	•	Started → Completed → Generated → Saved → Completed → Check-in
	•	show counts + conversion %

Row 3 — Switch Performance

Two charts:
	•	completions by switch (bar)
	•	helped positive by switch (bar)

Row 4 — Recommendation Engine
	•	acceptance rate
	•	swap rate
	•	completion within 24h

Row 5 — TimeBand & Mode
	•	timeBand distribution (bar)
	•	completion rate by timeBand
	•	helped by mode

Row 6 — Flags & Pain
	•	top flags last 14d (table)
	•	flag → rec switch → completion in 24h (table)

Row 7 — Errors
	•	errors/session
	•	top error codes (table)

Acceptance
	•	Page loads only for admin
	•	Uses /api/admin/metrics/* only
	•	No raw user content displayed

⸻

7) USER DASHBOARD SAFETY (PROGRESS ONLY)

User route: /profile/progress

Show only:
	•	system snapshot
	•	switch statuses
	•	weekly wins
	•	friendly patterns (sanitized)
	•	next best move

Sanitization rule

Convert internal flags → friendly labels:
	•	overwhelmFlag → “Felt overwhelmed”
	•	timeChaosFlag → “Days felt scattered”
etc.

No admin metrics, ever.

⸻

8) UI LINK PLACEMENT (PROFILE)

Only show admin link if role is admin:
	•	Profile bottom: “Admin Analytics”

Non-admin users never see it.

⸻

9) ERROR + OBSERVABILITY

If admin API returns 401/403:
	•	show “Not authorized”
	•	log ERROR_OCCURRED with code ADMIN_FORBIDDEN

⸻

10) TEST PLAN (YOU CAN RUN THIS)

As a normal user:
	•	Visit /admin/analytics → blocked UI
	•	Call /api/admin/metrics/summary → 403

As admin:
	•	/admin/analytics loads
	•	KPI tiles show real numbers

⸻

Paste-this “instruction message” to Replit AI

Implement an admin-only analytics dashboard inside this app (Vite + React + Wouter + React Query + Express sessions + Postgres Drizzle).

Requirements:
1) Add users.role enum ('user'|'admin') default 'user' in Drizzle schema + migration.
2) Backend: add requireAuth + requireAdmin middleware using session user.
3) Backend: create /api/admin/metrics/* endpoints (summary, funnel, switches, recommendations, timeband, flags, errors). All endpoints must be requireAdmin and return aggregated data only (no raw free text).
4) Frontend: add /api/me query via React Query to get role.
5) Frontend: add AdminRoute wrapper that blocks /admin/analytics for non-admin.
6) Frontend: build /admin/analytics page using shadcn/ui + Recharts with the layout: KPI tiles, funnel, switch charts, recommendation stats, timeband/mode charts, flags tables, errors tables.
7) Add Profile link to Admin Analytics visible only for admin.

Do not expose admin analytics to regular users. Protect both UI route and API endpoints.
After implementing, list files changed and manual test steps.


⸻

If you want, I can also write the exact shape of the JSON responses for each endpoint (summary/funnel/switches/etc.) so Replit AI doesn’t improvise the payloads.